generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profile       Profile?
  family        Family?   @relation(fields: [familyId], references: [id])
  familyId      String?
  meals         Meal[]
  workouts      Workout[]
  weightLogs    WeightLog[]
  pushSubs      PushSubscription[]
  supplements   Supplement[]
  bloodTests    BloodTest[]
  chatMessages  ChatMessage[]
  settings      UserSettings?
}

model Profile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  birthDate     DateTime?
  height        Float?
  weight        Float?
  gender        Gender?
  activityLevel ActivityLevel @default(MODERATE)
  goal          Goal      @default(MAINTAIN)
  targetWeight  Float?
  
  bmi           Float?
  bmr           Float?
  tdee          Float?
  dailyCalories Int?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Family {
  id          String   @id @default(cuid())
  name        String
  inviteCode  String   @unique @default(cuid())
  createdAt   DateTime @default(now())
  members     User[]
}

model Meal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  imageUrl    String?
  mealType    MealType
  date        DateTime @default(now())
  
  calories    Int?
  protein     Float?
  carbs       Float?
  fat         Float?
  fiber       Float?
  
  aiAnalysis  String?
  createdAt   DateTime @default(now())
}

model Workout {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  type        WorkoutType
  duration    Int
  calories    Int?
  date        DateTime @default(now())
  exercises   Exercise[]
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Exercise {
  id          String   @id @default(cuid())
  workoutId   String
  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  
  name        String
  sets        Int?
  reps        Int?
  duration    Int?
  restTime    Int?
  calories    Int?
  completed   Boolean  @default(false)
}

model WeightLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  weight      Float
  date        DateTime @default(now())
  note        String?
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
}

// ========== NOUVEAUX MODÃˆLES ==========

model Supplement {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  brand       String?
  dosage      String?
  frequency   String   @default("daily")
  timeOfDay   String?
  purchaseUrl String?
  notes       String?
  active      Boolean  @default(true)
  
  logs        SupplementLog[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SupplementLog {
  id           String     @id @default(cuid())
  supplementId String
  supplement   Supplement @relation(fields: [supplementId], references: [id], onDelete: Cascade)
  takenAt      DateTime   @default(now())
  notes        String?
}

model BloodTest {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date      DateTime
  labName   String?
  results   Json
  notes     String?
  fileUrl   String?
  
  createdAt DateTime @default(now())
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role      String
  content   String
  provider  String?
  
  createdAt DateTime @default(now())
}

model UserSettings {
  id              String  @id @default(cuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  groqApiKey      String?
  openaiApiKey    String?
  claudeApiKey    String?
  geminiApiKey    String?
  defaultProvider String  @default("groq")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ========== ENUMS ==========

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

enum Goal {
  LOSE
  MAINTAIN
  GAIN
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum WorkoutType {
  CARDIO
  STRENGTH
  FLEXIBILITY
  HIIT
  YOGA
  WALKING
  RUNNING
  CYCLING
  SWIMMING
  OTHER
}
