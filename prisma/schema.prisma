generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profile       Profile?
  healthProfile HealthProfile?
  family        Family?   @relation(fields: [familyId], references: [id])
  familyId      String?
  meals         Meal[]
  workouts      Workout[]
  weightLogs    WeightLog[]
  pushSubs      PushSubscription[]
  supplements   Supplement[]
  bloodTests    BloodTest[]
  chatMessages  ChatMessage[]
  settings      UserSettings?
  recommendations Recommendation[]
}

model Profile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  birthDate     DateTime?
  height        Float?
  weight        Float?
  gender        Gender?
  activityLevel ActivityLevel @default(MODERATE)
  goal          Goal      @default(MAINTAIN)
  targetWeight  Float?
  
  bmi           Float?
  bmr           Float?
  tdee          Float?
  dailyCalories Int?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Nouveau: Profil Santé Avancé
model HealthProfile {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Objectifs
  primaryGoal   HealthGoal @default(GENERAL_HEALTH)
  secondaryGoals String[]  // Array of HealthGoal values
  
  // Budget
  monthlyBudget Int?      // Budget mensuel compléments en euros
  
  // Mode de vie
  sleepHours    Float?    // Heures de sommeil moyennes
  stressLevel   StressLevel @default(MODERATE)
  dietType      DietType  @default(OMNIVORE)
  allergies     String[]  // Allergies alimentaires
  
  // Mesures corporelles
  waistCircumference Float? // Tour de taille cm
  bodyFatPercent     Float? // % masse grasse
  muscleMass         Float? // kg
  
  // Marqueurs sanguins (derniers résultats)
  cholesterolTotal   Float?
  cholesterolHDL     Float?
  cholesterolLDL     Float?
  triglycerides      Float?
  glycemia           Float? // Glycémie à jeun
  hba1c              Float? // Hémoglobine glyquée
  vitaminD           Float?
  vitaminB12         Float?
  iron               Float? // Fer sérique
  ferritin           Float?
  crp                Float? // Protéine C-réactive (inflammation)
  homocysteine       Float?
  testosterone       Float? // ng/dL
  tsh                Float? // Thyroïde
  
  // Conditions
  conditions    String[]  // Diabète, hypertension, etc.
  medications   String[]  // Médicaments actuels
  
  // Onboarding
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Recommandations IA
model Recommendation {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        RecommendationType
  category    String   // supplements, diet, exercise
  title       String
  description String
  priority    Int      @default(1) // 1 = haute, 5 = basse
  
  // Pour les compléments
  supplementName  String?
  dosage          String?
  timing          String?  // morning, evening, with-meal
  purchaseUrl     String?
  monthlyPrice    Float?
  
  // Pour les repas
  mealPlan    Json?
  
  // Pour l'exercice
  exercisePlan Json?
  
  // Statut
  accepted    Boolean  @default(false)
  dismissed   Boolean  @default(false)
  
  reasoning   String?  // Pourquoi cette recommandation
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Family {
  id          String   @id @default(cuid())
  name        String
  inviteCode  String   @unique @default(cuid())
  createdAt   DateTime @default(now())
  members     User[]
}

model Meal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  imageUrl    String?
  mealType    MealType
  date        DateTime @default(now())
  
  calories    Int?
  protein     Float?
  carbs       Float?
  fat         Float?
  fiber       Float?
  
  aiAnalysis  String?
  createdAt   DateTime @default(now())
}

model Workout {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  type        WorkoutType
  duration    Int
  calories    Int?
  date        DateTime @default(now())
  exercises   Exercise[]
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Exercise {
  id          String   @id @default(cuid())
  workoutId   String
  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  
  name        String
  sets        Int?
  reps        Int?
  duration    Int?
  restTime    Int?
  calories    Int?
  completed   Boolean  @default(false)
}

model WeightLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  weight      Float
  date        DateTime @default(now())
  note        String?
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
}

model Supplement {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  brand       String?
  dosage      String?
  frequency   String   @default("daily")
  timeOfDay   String?
  purchaseUrl String?
  notes       String?
  active      Boolean  @default(true)
  isRecommended Boolean @default(false)
  
  logs        SupplementLog[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SupplementLog {
  id           String     @id @default(cuid())
  supplementId String
  supplement   Supplement @relation(fields: [supplementId], references: [id], onDelete: Cascade)
  takenAt      DateTime   @default(now())
  notes        String?
}

model BloodTest {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date      DateTime
  labName   String?
  results   Json
  notes     String?
  fileUrl   String?
  
  createdAt DateTime @default(now())
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role      String
  content   String
  provider  String?
  isOnboarding Boolean @default(false)
  
  createdAt DateTime @default(now())
}

model UserSettings {
  id              String  @id @default(cuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  groqApiKey      String?
  openaiApiKey    String?
  claudeApiKey    String?
  geminiApiKey    String?
  defaultProvider String  @default("groq")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ========== ENUMS ==========

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

enum Goal {
  LOSE
  MAINTAIN
  GAIN
}

enum HealthGoal {
  GENERAL_HEALTH
  WEIGHT_LOSS
  MUSCLE_GAIN
  ENERGY
  LONGEVITY
  COGNITIVE
  SLEEP
  STRESS
  IMMUNITY
  HEART_HEALTH
  GUT_HEALTH
  SKIN_HAIR
  HORMONES
}

enum StressLevel {
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

enum DietType {
  OMNIVORE
  VEGETARIAN
  VEGAN
  PESCATARIAN
  KETO
  PALEO
  MEDITERRANEAN
  LOW_CARB
  INTERMITTENT_FASTING
}

enum RecommendationType {
  SUPPLEMENT
  MEAL
  EXERCISE
  LIFESTYLE
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum WorkoutType {
  CARDIO
  STRENGTH
  FLEXIBILITY
  HIIT
  YOGA
  WALKING
  RUNNING
  CYCLING
  SWIMMING
  ZONE2
  OTHER
}
